const e=require("child_process"),{parse:n}=require("@babel/parser"),o=require("@babel/generator"),r=require("@babel/types"),t=require("@babel/traverse"),s=new Map,i=new Map,l=e.execSync("git config user.name",{encoding:"utf-8"});module.exports=()=>({name:"rollup-plugin-remove-others-console",enforce:"pre",transform:(c,a)=>{if(!a.includes("node_modules")&&c.includes("console.log")){const p=(n=>{const o=e.execSync(`git rev-parse ${n}`,{encoding:"utf-8"}).trim();if(i.has(n)&&i.get(n)===o)return s.get(n)||"";const r=e.execSync(`git log --pretty="%an" -- ${n}`,{encoding:"utf-8"});return s.set(n,r),i.set(n,o),r})(a);if(!p.includes(l))return c.replace(/console\.log\((?:[^)(]|\((?:[^)(]+|\([^)(]*\))*\))*\)[;\n]?/g,"{}\n");const u=n(c,{sourceType:"module",plugins:["jsx","tsx","vue","typescript","classProperties"]}),d=[];t(u,{CallExpression(e){if(r.isMemberExpression(e.node.callee)&&r.isIdentifier(e.node.callee.object,{name:"console"})&&r.isIdentifier(e.node.callee.property,{name:"log"})){const n=e.node.loc.start.line;d.push(n)}}});const m=d.filter((n=>{const o=((n,o)=>{const r=e.execSync(`git blame -L ${n},${n} --porcelain ${o}`,{encoding:"utf-8"}).match(/^author (.*)$/m);return r?r[1].trim():""})(n,a);return o!==l&&"Not Committed Yet"!==o}));t(u,{CallExpression(e){if(r.isMemberExpression(e.node.callee)&&r.isIdentifier(e.node.callee.object,{name:"console"})&&r.isIdentifier(e.node.callee.property,{name:"log"})){const n=e.node.loc.start.line;if(m.includes(n)){if(e.parentPath.isExpressionStatement())e.replaceWith(r.callExpression(r.identifier("/* console.log removed */"),[]));else{const n=r.objectExpression([]);n.trailingComments=[{type:"CommentLine",value:"// console.log removed"}],e.replaceWith(n)}}}}});return o(u).code}return c}});
